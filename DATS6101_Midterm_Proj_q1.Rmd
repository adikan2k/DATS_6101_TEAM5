---
title: "DATS6101_Midterm_Proj_q1"
author: "Annie Cheng"
date: "2024-10-14"
output: html_document
---
```{r}
library(stringr)
library(tidyverse)
library(dplyr)
library(car)
library(PMCMRplus)
```

# 1 Data Proprocessing
## 1.1 Load the data
```{r include=FALSE}
accidents <- read_csv("/Users/chengyuhan/Desktop/DATS6101/midterm proj/dataset/NTAD_Fatality_Analysis_Reporting_System_2022_Accidents.csv")

```

## 1.2 Overview of Dataframe
```{r include=FALSE}
# dimension of dataframe
dim(accidents)
str(accidents)
# first 5 rows 
head(accidents, 5)
# all column names
colnames(accidents)
```


## 1.3 Check for missing value
```{r include=FALSE}
# no of missing value for each column
colSums(is.na(accidents))

# Drop columns with missing values: x, y (duplicated), and tway_id2 (irrelevant)
accidents <- accidents %>% 
  select(
    -c("TWAY_ID2",
       "x",
       "y"))

accidents
```

## 1.4 Cleaning Column Names
```{r Data Cleaning: Select}
# Convert the column names into lowercase
colnames(accidents) <- tolower(colnames(accidents))
```

## 1.5 Select relevant Columns
```{r}
# Select Relevant Columns
cleaned_accidents <-  accidents %>% 
  select("statename", 
         "county",
         "city",
         "month",
         "day",
         "day_week",
         "hour",
         "minute",
         "rur_urb",
         "nhs",
         "sp_jur",
         "latitude",
         "longitud",
         "harm_ev",
         "reljct1name",
         "reljct2name",
         "typ_int",
         "rel_road",
         "wrk_zone",
         "lgt_cond",
         "weather",
         "fatals")
```

## 1.6 Convert Variables into right Data Type
```{r Data Cleaning: Convert the data type, include=FALSE}
# Convert some variables into factor variables
cleaned_accidents$day_week <- factor(cleaned_accidents$day_week)
cleaned_accidents$hour <- factor(cleaned_accidents$hour)

str(cleaned_accidents)
```

# 2. Temporal Analysis (Hour, Day of Week)
SMART question 1: How does day of week and hour of day affect the occurrence and severity of fatal accidents?
SMART question 2: Does day of week affect the day to day variation on total fatalities per day?

## Data Subsetting and Preparation
Subset for temporal question
```{r Q1:Create Temporal Subset}
# Select columns consists of temporal factors (month, day, day_week, hour) and no of fatalities (fatals)
df_temporal <- cleaned_accidents %>% 
  select("month",
         "day",
         "day_week",
         "hour",
         "fatals")

# Create a new column to stored the date
df_temporal <- df_temporal %>%
  mutate(
    date = as.Date(paste("2022", month, day, sep = "-"), format = "%Y-%m-%d"),
    day_week_name = 
      case_when(
      day_week ==1 ~ "Sunday",
      day_week ==2 ~ "Monday",
      day_week ==3 ~ "Tuesday",
      day_week ==4 ~ "Wednesday",
      day_week ==5 ~ "Thursday",
      day_week ==6 ~ "Friday",
      day_week ==7 ~ "Saturday",
      ),
    day_type = ifelse(day_week %in% 2:6, "Weekday", "Weekend"),
   fatal_category = ifelse(fatals > 1, "multiple", "one")) 


# convert into factor variable and set up levl
df_temporal$day_week_name <- factor(df_temporal$day_week_name, levels = c("Sunday","Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))

```

Check if every date in 2022 is included in the data frame, all dates in 2022 are included.
```{r eval=FALSE, include=FALSE}
# Generate all dates for the year 2022
all_dates_2022 <- seq.Date(from = as.Date("2022-01-01"), to = as.Date("2022-12-31"), by = "day")

# Extract unique dates from the accident table
accident_dates <- unique(df_temporal$date)

# Find dates in 2022 that are missing from the accident table
missing_dates <- setdiff(all_dates_2022, accident_dates)
missing_dates # none: all included
```

Calculate for the frequency of day of week in the data frame, the frequency for Monday to 
```{r include=FALSE}

unique_dates <- df_temporal %>%
  select(date, day_week, month) %>%
  distinct()
unique_dates[order(unique_dates$date), ]

# Count the frequency of day of week
day_of_week_counts <- unique_dates %>%
  group_by(day_week) %>%
  summarise(count = n())
day_of_week_counts

# Count the frequency of Weekday and weekend
weekday_weekend_counts <- day_of_week_counts %>%
  mutate(category = ifelse(day_week %in% 2:6, "Weekday", "Weekend"))

# Summarize the total counts for Weekdays and Weekends
total_weekday_weekend_counts <- weekday_weekend_counts %>%
  group_by(category) %>%
  summarise(total_count = sum(count))
total_weekday_weekend_counts

total_weekday_weekend_counts

```


## 2.1 Accident Occurence Analysis
### Summary Statistics
#### Hour of Day
```{r}
# Filter out unknown hour (hour==99)
df_hour <- df_temporal %>% 
  filter(hour != 99) %>% 
  mutate(hour = droplevels(hour))

df_hour_accidents <- df_hour %>% 
  group_by(hour) %>% 
  summarise(total_accidents = n())%>% 
  ungroup()
df_hour_accidents

# Top 5 hours with the highest number of fatal accidents
#head(df_hour_accidents[order(df_hour_accidents$total_accidents, decreasing = TRUE), ], 5)
# Top 5 hours with the lowest number of fatal accidents
#head(df_hour_accidents[order(df_hour_accidents$total_accidents), ], 5)
```

The peak hours for the highest number of accidents occur between 6 PM and 10 PM.

#### Day of Week
```{r}
df_wday_accidents <- df_temporal %>% 
  group_by(day_week) %>% 
  summarise(total_accidents = n())%>% 
  ungroup()
df_wday_accidents
```

Saturday and Sunday appears to have higher count of fatal accidents than rest of days of week.
 
### Data Visualization
#### Hour of Day
```{r}
# Count of Fatal Accidents
df_hour %>% ggplot(aes(x= hour, fill = as.numeric(as.character(hour)) >= 6 & as.numeric(as.character(hour)) < 18)) +
  geom_bar()+
  labs(x = "hour", y = "Number of Fatal Accidents", 
       title = "Count of Fatal Accidents by Hour",
       fill = "hour")+
  scale_fill_manual(values = c("TRUE" = "#E69F00", "FALSE" = "#0072B2"), 
                    labels = c("Nighttime", "Daytime")) +
  theme_minimal()
```
### Day of Week
```{r}
# Change the day_week number into name of day of week
levels(df_wday_accidents$day_week) <- c("Sunday","Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")

df_wday_accidents <- df_wday_accidents %>%
  mutate(day_type = ifelse(day_week %in% c("Saturday", "Sunday"), "Weekend", "Weekday"))


# Data Visualization on Occurrence of fatal accidents per day of week
df_temporal %>% ggplot(aes(x= day_week, fill = day_type)) +
  geom_bar()+
  labs(x = "Day of the Week", y = "Number of Fatal Accidents", 
       title = "Frequency of Fatal Accidents by Day of the Week",
       fill = "Day of Week") +  
  scale_fill_manual(values = c("#bfbfbf", "#0072B2"), 
                    labels = c("weekend", "weekday")) +
  theme_minimal()

```

### Statistical Testing: 
We use Chi-squared test to determine whether accidents are uniformly distributed across hours of the day/days of week. 
#### Hour of Day
```{r Hour of Day}
# chi-squared test on the occurrence of accident
table(df_hour$hour)
chisq_result <- chisq.test(table(df_hour$hour))
chisq_result
```

#### Day of Week
```{r : Statistical Testing}
# chi-squared test on the occurrence of accident
df_temporal
table(df_temporal$day_week)
chisq_result <- chisq.test(table(df_temporal$day_week))
chisq_result
```

P-value for both test are less than 0.05, indicating that there is a statistically significant deviation from a uniform distribution, suggesting that certain hours and days have higher frequencies of accidents compared to others.


# 3. Severity Analysis
Severity is defined as the number of fatalities per accident. Since the majority of accident has one fatality in an accident and limited occurrence on accidents with fatalities more than four, we will group the number of fatalities into *"one"* and *"multiple"* fatalities.

### Summary Statistics
#### Hour of Day
```{r}
hr_contingency <- table(df_hour$hour, df_hour$fatal_category)
hr_contingency
```
#### Day of Week
```{r}
# Severity: categorize accidents into accident with one fatality and multiple
fatality_counts <- df_temporal %>%
  group_by(day_week, fatal_category) %>%
  summarize(count = n())
df_temporal

wday_contingency <- table(df_temporal$day_week_name, df_temporal$fatal_category)
wday_contingency
```


### Data Visualization
#### Hour of Day
```{r fig.width=12, fig.height=6}
# Convert contingency table into data frame and rename column names
df_hr_contingency <- data.frame(hr_contingency)
colnames(df_hr_contingency)<- c("hour", "fatal_category", "Freq")

#data viz
df_hr_contingency %>% 
  ggplot(aes(x= hour, y = Freq, fill = fatal_category))+
  geom_bar(stat="identity", alpha = 0.75) +
  facet_wrap(~ fatal_category, scales = "free_y")+
  labs(y = "Frequency")
```

#### Day of Week
```{r fig.width=8, fig.height=6}
# Convert contingency table into data frame and rename column names
df_wday_contingency <- data.frame(wday_contingency)
colnames(df_wday_contingency)<- c("day_week_name", "fatal_category", "Freq")

# data visualization on Severity by day of week
df_wday_contingency %>% ggplot(aes(x= day_week_name, y = Freq, fill = fatal_category))+
  geom_bar(stat="identity", alpha = 0.75) +
  facet_wrap(~ fatal_category, scales = "free_y")+
  labs(x = "Day of the Week", y = "Frequency", title = "Severity by Day of Week") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


### Statistical Testing
#### Hour of Day
```{r}
# Chi-squared test: hour of day
chi_sq_result <- chisq.test(hr_contingency)
print(chi_sq_result)

# standardized residuals table
# get the expected and observed values
observed <- chi_sq_result$observed
expected <- chi_sq_result$expected
# calculate the standardized residuals
standardized_residuals <- (observed - expected) / sqrt(expected)
print(standardized_residuals)

```
P-value less than 0.05, we can reject the null hypothesis at 5% level of significance. This indicates a significant relationship between the number of fatalities per accident ('one' vs. 'multiple') and the hour of the day. 

#### Day of Week
```{r}

chi_sq_test<- chisq.test(wday_contingency)

# Get observed and expected counts
observed <- chi_sq_test$observed
expected <- chi_sq_test$expected

# Calculate standardized residuals
standardized_residuals <- (observed - expected) / sqrt(expected)
print(standardized_residuals)
```

The result reveals a clear pattern in the data, highlighting that weekends are associated with more severe accidents involving multiple fatalities. 



## Daily Fatalities
Look further into total fatalities per day to provide a more nuanced undertanding on how does temporal factors affect fatal accidents.
```{r}
# Data frame for daily fatalities
df_daily <- df_temporal %>%
  group_by(date,month, day_week_name) %>%
  summarise(
    total_accidents = n(),
    average_fatals = mean(fatals),
    total_fatals = sum(fatals)
  ) %>% 
  ungroup()

# convert to the right data type
df_daily$day_week_name <- factor(df_daily$day_week_name, levels =  c("Sunday","Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))
df_daily$month <- factor(df_daily$month)

```

### Top 5 Dates with Highest and Lowest Fatalities
```{r}
# Top 5 Highest Daily Fatalities
head(df_daily[order(df_daily$total_fatals, decreasing = TRUE), ], 5)
# Top 5 Lowest Daily Fatalities
tail(df_daily[order(df_daily$total_fatals, decreasing = TRUE), ], 5)
```

### Data Visualization:Daily fatalities by day of week
```{r Day of Week: data viz}
# names of days of week
df_daily


df_daily <- df_daily %>%
  mutate(day_type = ifelse(day_week_name %in% c("Saturday", "Sunday"), "Weekend", "Weekday"))


# Boxplot of daily fatlities by day of week
df_daily %>% ggplot(aes(x = day_week_name, y = total_fatals, fill = day_type))+
  geom_boxplot() +
  labs(x = "Day of the Week", 
       y = "Daily Fatalities", 
       title = "Daily Fatalities by Day of the Week")+
  scale_fill_manual(values = c("#bfbfbf","#0072B2"))


```

The boxplot shows that daily fatalities are generally higher on weekends. This suggests that weekends tend to have a higher count of fatalities, potentially due to increased travel.

## Summary Statistics of Day of Week
```{r avg daily fatalities by day of week}
 df_summary_day_week <- df_daily %>% 
  group_by(day_week_name) %>% 
  summarise(
    sample_size = n(),
    avg_fatalities = mean(total_fatals),
    std_fatalities = sd(total_fatals)) %>% 
  ungroup()

df_summary_day_week
```

The average and standard deviation of daily fatalities are notably higher on weekends, indicating both a higher mean and greater variability in fatalities compared to weekdays. The sample size is balanced across groups.

### Check for Normality and Homogeneity of Variance
```{r}
# QQ plot
for(day in unique(df_daily$day_week_name)) {
  qqnorm(df_daily$total_fatals[df_daily$day_week_name == day], 
         main = paste("Q-Q Plot for ", day))
  qqline(df_daily$total_fatals[df_daily$day_week_name == day], col = "blue")
}


# Shapiro: Normality test
df_daily %>%
  group_by(day_week_name) %>%
  summarise(normality_p_value = shapiro.test(total_fatals)$p.value)
# Levene test: Homogeneiety of Variance
leveneTest(total_fatals ~ day_week_name, data = df_daily)
```

Since the number of fatalities per day is relatively large and spans a wide range of values, the daily fatality counts approximate a continuous variable. Combined with sufficiently large sample sizes for each day of the week, the Central Limit Theorem applies, making the sampling distribution of the mean fatalities per day approximately normal. Additionally, normality tests on daily fatalities grouped by day of the week do not reject the assumption of normality. Therefore, we can treat fatalities per day as approximately continuous and appropriately use ANOVA to test for differences across the days of the week

After doing the Leven's test for homogeneity, we can conclude that the variances across the groups are significantly different at 5% level of significance. This indicates that the homogeneity assumption of ANOVA test is violated. So we will be using Welch's ANOVA test in the following section

### Statistical Testing
```{r Day of Week: ANOVA}
# Welch's ANOVA
Wanova_result <- oneway.test(total_fatals ~ day_week_name, data = df_daily, var.equal = FALSE)
Wanova_result
# post hoc test-Games Howell

posthoc_result <- gamesHowellTest(total_fatals ~ day_week_name, data = df_daily)
print(posthoc_result)
```

p-values <0.05, there is a statistically significant difference (p-value < 0.05) in the number of daily fatalities across different days of the week. This indicates that day of week can affect daily fatality counts.


